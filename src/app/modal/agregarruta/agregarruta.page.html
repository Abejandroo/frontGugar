<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Planificar Ruta</ion-title> <ion-buttons slot="end">
      <ion-button (click)="cerrarModal()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  
  <form [formGroup]="formRuta">
    <ion-list>
      <ion-item>
        <ion-input label="NOMBRE DE LA RUTA" labelPlacement="floating" placeholder="Ej. RUTA CENTRO" formControlName="nombre"></ion-input>
      </ion-item>

      <ion-item>
        <ion-select label="REPARTIDOR" labelPlacement="floating" formControlName="rutaId" placeholder="Selecciona un conductor" interface="popover"> 
          @for (rep of repartidores; track rep.id) {
            <ion-select-option [value]="rep.id">{{ rep.name }}</ion-select-option>
          }
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-input label="DESCRIPCIÃ“N / ZONA" labelPlacement="floating" formControlName="lugarEntrega"></ion-input>
      </ion-item>

      <ion-item>
        <ion-input label="CANTIDAD PAQUETES" type="number" labelPlacement="floating" formControlName="cantidad" min="0"></ion-input>
      </ion-item>

      <ion-item>
        <ion-input label="ACCIONES ESPECIALES" labelPlacement="floating" formControlName="acciones"></ion-input>
      </ion-item>
    </ion-list>

    <div class="ion-text-center ion-margin-top">
      <p class="ion-text-muted">
        <ion-icon name="finger-print"></ion-icon> Toca el mapa para agregar paradas (A, B, C...)
      </p>
      <ion-badge color="secondary" *ngIf="puntosRuta.length > 0">
        {{ puntosRuta.length }} Paradas marcadas
      </ion-badge>
    </div>

    <div class="map-container ion-margin-top">
      <google-map 
        height="350px" 
        width="100%" 
        [center]="center" 
        [zoom]="zoom"
        (mapClick)="agregarPuntoAlMapa($event)">
        
        <map-polyline [path]="puntosRuta" [options]="polylineOptions"></map-polyline>
        
        @for (punto of puntosRuta; track punto; let i = $index) {
          <map-marker 
            [position]="punto"
            [label]="obtenerLetraMarcador(i)"
            [title]="'Parada ' + (i + 1)">
          </map-marker>
        }

      </google-map>
    </div>

    @if (puntosRuta.length > 0) {
      <ion-grid>
        <ion-row>
          <ion-col size="4">
            <ion-button fill="outline" color="medium" expand="block" size="small" (click)="deshacerUltimo()">
              <ion-icon name="arrow-undo" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col size="4">
            <ion-button fill="outline" color="danger" expand="block" size="small" (click)="limpiarRuta()">
              <ion-icon name="trash" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col size="4">
            <ion-button fill="solid" color="tertiary" expand="block" size="small" (click)="cerrarCircuito()" [disabled]="puntosRuta.length < 2">
              <ion-icon name="repeat" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    }

    <div class="ion-padding-top">
      <ion-button expand="block" (click)="agregarGrupo()" shape="round">
        <ion-icon name="save-outline" slot="start"></ion-icon>
        Guardar Ruta Completa
      </ion-button>
    </div>

  </form>
</ion-content>