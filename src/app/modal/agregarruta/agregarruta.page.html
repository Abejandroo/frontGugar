<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Planificar Ruta</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cerrarModal()">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  
  <form [formGroup]="formRuta">
    
    <!-- MODO: Nueva ruta o Agregar a existente -->
    <ion-segment [(ngModel)]="modoCreacion" (ionChange)="onModoChange()" [ngModelOptions]="{standalone: true}">
      <ion-segment-button value="nueva">
        <ion-label>Nueva Ruta</ion-label>
      </ion-segment-button>
      <ion-segment-button value="agregar" [disabled]="rutasConDiasFaltantes.length === 0">
        <ion-label>Agregar DÃ­a</ion-label>
      </ion-segment-button>
    </ion-segment>

    <ion-list>
      
      <!-- OPCIÃ“N A: Crear nueva ruta -->
      @if (modoCreacion === 'nueva') {
        <ion-item>
          <ion-input 
            label="NOMBRE DE LA RUTA" 
            labelPlacement="floating" 
            placeholder="Ej. RUTA CENTRO" 
            formControlName="nombreRuta">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-select 
            label="SUPERVISOR (Opcional)" 
            labelPlacement="floating" 
            formControlName="supervisorId" 
            placeholder="Selecciona supervisor" 
            interface="popover">
            <ion-select-option [value]="null">Sin supervisor</ion-select-option>
            @for (sup of supervisores; track sup.id) {
              <ion-select-option [value]="sup.id">{{ sup.name }}</ion-select-option>
            }
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-select 
            label="REPARTIDOR (Opcional)" 
            labelPlacement="floating" 
            formControlName="repartidorId" 
            placeholder="Selecciona repartidor" 
            interface="popover">
            <ion-select-option [value]="null">Sin repartidor</ion-select-option>
            @for (rep of repartidores; track rep.id) {
              <ion-select-option [value]="rep.id">{{ rep.name }}</ion-select-option>
            }
          </ion-select>
        </ion-item>
      }

      <!-- OPCIÃ“N B: Agregar dÃ­a a ruta existente -->
      @if (modoCreacion === 'agregar') {
        <ion-item>
          <ion-select 
            label="SELECCIONA RUTA" 
            labelPlacement="floating" 
            formControlName="rutaExistenteId" 
            placeholder="Elige una ruta" 
            interface="action-sheet"
            (ionChange)="onRutaExistenteChange($event)">
            @for (ruta of rutasConDiasFaltantes; track ruta.id) {
              <ion-select-option [value]="ruta.id">
                {{ ruta.nombre }} (Le faltan: {{ ruta.diasFaltantes.join(', ') }})
              </ion-select-option>
            }
          </ion-select>
        </ion-item>

        @if (formRuta.get('rutaExistenteId')?.value) {
          <ion-note class="ion-padding-start" color="primary">
            <small>
              ðŸ’¡ DÃ­as disponibles: {{ getDiasFaltantes(formRuta.get('rutaExistenteId')?.value).join(', ') }}
            </small>
          </ion-note>
        }
      }

      <!-- DÃA DE VISITA (Obligatorio) -->
      <ion-item>
        <ion-select 
          label="DÃA DE VISITA" 
          labelPlacement="floating" 
          formControlName="diaSemana" 
          placeholder="Selecciona dÃ­as" 
          interface="popover">
          @for (dia of diasSemana; track dia.value) {
            <ion-select-option [value]="dia.value">
              {{ dia.label }}
            </ion-select-option>
          }
        </ion-select>
      </ion-item>

    </ion-list>

    <!-- SECCIÃ“N: CLIENTES DISPONIBLES -->
    <div class="ion-margin-top">
      <div class="section-header">
        <h3>Clientes Disponibles</h3>
        <ion-badge color="secondary">{{ clientesDisponibles.length }}</ion-badge>
      </div>

      <!-- Buscador -->
      <ion-searchbar 
        [(ngModel)]="busquedaCliente" 
        [ngModelOptions]="{standalone: true}"
        placeholder="Buscar cliente..." 
        animated>
      </ion-searchbar>

      <!-- Lista de clientes -->
      <ion-list class="clientes-list">
        @for (cliente of clientesFiltrados; track cliente.id) {
          <ion-item button (click)="seleccionarCliente(cliente)">
            <ion-label>
              <h3>{{ cliente.representante }}</h3>
              <p>{{ cliente.direcciones[0]?.direccion }}, {{ cliente.direcciones[0]?.colonia }}</p>
            </ion-label>
            <ion-badge slot="end" color="primary">
              ${{ cliente.tipoPrecio?.precioPorGarrafon || 'N/A' }}
            </ion-badge>
          </ion-item>
        }
        @empty {
          <ion-item>
            <ion-label class="ion-text-center">
              <p>No hay clientes disponibles</p>
            </ion-label>
          </ion-item>
        }
      </ion-list>
    </div>

    <!-- SECCIÃ“N: ORDEN DE VISITA -->
    @if (clientesSeleccionados.length > 0) {
      <div class="ion-margin-top">
        <div class="section-header">
          <h3>Orden de Visita</h3>
          <ion-badge color="success">{{ clientesSeleccionados.length }} clientes</ion-badge>
        </div>

        <ion-list>
          @for (cliente of clientesSeleccionados; track cliente.id; let i = $index) {
            <ion-item>
              <ion-badge slot="start" color="tertiary">{{ obtenerLetraMarcador(i) }}</ion-badge>
              <ion-label>
                <h3>{{ cliente.representante }}</h3>
                <p>{{ cliente.direcciones[0]?.colonia }}</p>
              </ion-label>
              <ion-button slot="end" fill="clear" (click)="quitarCliente(i)">
                <ion-icon name="close" color="danger"></ion-icon>
              </ion-button>
            </ion-item>
          }
        </ion-list>

        <ion-button 
          expand="block" 
          fill="outline" 
          color="danger" 
          (click)="limpiarTodo()">
          <ion-icon name="trash" slot="start"></ion-icon>
          Limpiar Todo
        </ion-button>
      </div>
    }

    <!-- MAPA DE LEAFLET -->
    <div class="ion-margin-top">
      <h3>Vista de Ruta</h3>
      <div id="mapLeaflet" style="height: 300px; width: 100%; border-radius: 8px;"></div>
    </div>

    <!-- BOTÃ“N GUARDAR -->
    <div class="ion-padding-top">
      <ion-button 
        expand="block" 
        (click)="agregarGrupo()" 
        shape="round"
        [disabled]="formRuta.invalid || clientesSeleccionados.length === 0">
        <ion-icon name="save-outline" slot="start"></ion-icon>
        @if (modoCreacion === 'nueva') {
          Crear Ruta con {{ clientesSeleccionados.length }} clientes
        } @else {
          Agregar DÃ­a con {{ clientesSeleccionados.length }} clientes
        }
      </ion-button>
    </div>

  </form>
</ion-content>