<!-- src/app/components/importar-clientes-modal/importar-clientes-modal.component.html -->

<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="cerrarModal()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title> Importar Ruta desde Excel</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="import-container">

    <!-- SELECTOR DE ARCHIVO (Solo si no hay vista previa) -->
    @if(!mostrarVistaPrevia){
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="document"></ion-icon>
          Seleccionar Archivo Excel
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <input #fileInput type="file" accept=".xlsx,.xls,.csv" (change)="onFileSelected($event)" style="display: none;">

        <ion-button expand="block" color="primary" (click)="fileInput.click()" [disabled]="loading">
          <ion-icon name="folder-open" slot="start"></ion-icon>
          Seleccionar Archivo
        </ion-button>

        @if (archivoSeleccionado) {
        <div class="file-info">
          <ion-chip color="success">
            <ion-icon name="document-text"></ion-icon>
            <ion-label>{{ archivoSeleccionado.name }}</ion-label>
          </ion-chip>
        </div>
        }
      </ion-card-content>
    </ion-card>
    }
    <!-- VALIDACIN Y DATOS DE IMPORTACIN -->
    @if(mostrarVistaPrevia && mostrarSeccionValidacion){
    <div>

      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="clipboard-outline"></ion-icon>
            Datos de la Ruta
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>

          <!-- Nombre de ruta - REQUERIDO -->
          <ion-item>
            <ion-label position="stacked">
              <strong> Nombre de la ruta *</strong>
            </ion-label>
            <ion-input [(ngModel)]="nombreRuta" placeholder="Ej: San Felipe del Agua"
              [class.ion-invalid]="nombreRuta.trim().length === 0">
            </ion-input>
          </ion-item>

          <!-- Fecha (solo lectura) -->
          @if (fechaReporte) {
          <ion-item>
            <ion-label position="stacked">
              <strong> Fecha del reporte</strong>
            </ion-label>
            <ion-input [value]="fechaReporte" readonly></ion-input>
          </ion-item>
          }
        </ion-card-content>
      </ion-card>

      <!-- ASIGNACIN DE PERSONAL (OPCIONAL) -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="people-outline"></ion-icon>
            Personal (Opcional)
          </ion-card-title>
          <ion-card-subtitle>Puedes asignarlo despu茅s desde la pesta帽a Personal</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>

          <ion-item>
            <ion-label position="stacked">
              <strong> Supervisor</strong>
            </ion-label>
            <ion-select [(ngModel)]="supervisorId" placeholder="Sin asignar" interface="popover">
              <ion-select-option [value]="null">Sin asignar</ion-select-option>
              @for (sup of supervisores; track sup.id) {
              <ion-select-option [value]="sup.id">
                {{ sup.name }}
              </ion-select-option>
              }
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">
              <strong> Repartidor</strong>
            </ion-label>
            <ion-select [(ngModel)]="repartidorId" placeholder="Sin asignar" interface="popover">
              <ion-select-option [value]="null">Sin asignar</ion-select-option>
              @for (rep of repartidores; track rep.id) {
              <ion-select-option [value]="rep.id">
                {{ rep.name }}
              </ion-select-option>
              }
            </ion-select>
          </ion-item>

        </ion-card-content>
      </ion-card>

      <!-- PRECIOS FALTANTES -->
      @if (verificandoPrecios || preciosFaltantes.length > 0) {
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="cash-outline"></ion-icon>
            Precios Detectados
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>

          @if (verificandoPrecios) {
          <div class="ion-text-center ion-padding">
            <ion-spinner></ion-spinner>
            <p>Verificando precios en la base de datos...</p>
          </div>
          }
          @if (!verificandoPrecios && preciosFaltantes.length > 0) {
          <ion-list>
            @for (precio of preciosFaltantes; let i = $index; track i) {
            <ion-item color="warning">
              <ion-icon name="alert-circle" color="danger" slot="start"></ion-icon>
              <ion-label>
                <h3>${{ precio.precio }}</h3>
                <p>{{ precio.cantidad }} cliente(s) - No existe en BD</p>
              </ion-label>
              <ion-button slot="end" size="small" color="primary" (click)="crearPrecio(precio)">
                <ion-icon name="add" slot="start"></ion-icon>
                Crear
              </ion-button>
            </ion-item>
            }
          </ion-list>
          }
          @if (!verificandoPrecios && preciosFaltantes.length === 0) {
          <ion-note color="success">
            Todos los precios existen en la base de datos
          </ion-note>
          }

        </ion-card-content>
      </ion-card>
      }
    </div>
    }


    <!-- TABS CON MAPAS Y DOMICILIOS -->
    @if (mostrarVistaPrevia && mapasRutas.length > 0) {
    <div>

      <!-- Segment para los tabs -->
      <ion-segment [value]="tabSeleccionado" (ionChange)="cambiarTab($event)" mode="md" scrollable>
        @for (mapaRuta of mapasRutas; let i = $index; track i) {
        <ion-segment-button [value]="i.toString()">
          <ion-label>
            <strong>{{ mapaRuta.dias }}</strong>
            <br>
            <small>{{ mapaRuta.clientes.length }} clientes</small>
          </ion-label>
        </ion-segment-button>
        }
      </ion-segment>

      <!-- Contenido del tab seleccionado -->
      @for (mapaRuta of mapasRutas; let i = $index; track i) {
      <div>
        @if (tabSeleccionado === i.toString()) {
        <div class="tab-content">

          <!-- Mapa -->
          <ion-card class="map-card">
            <ion-card-header>
              <ion-card-title class="map-title">
                <ion-icon name="map-outline"></ion-icon>
                {{ mapaRuta.dias }}
              </ion-card-title>
              <ion-card-subtitle class="map-subtitle">
                <ion-icon name="location-outline"></ion-icon>
                {{ mapaRuta.clientes.length }} domicilios
              </ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <div [id]="'map-' + i" class="map-container"></div>
            </ion-card-content>
          </ion-card>

          <!-- CARD DEL CLIENTE SELECCIONADO (Aparece din谩micamente) -->
          @if (clienteSeleccionado) {
          <div class="cliente-seleccionado-wrapper" [@slideIn]>
            <ion-card class="cliente-seleccionado-card">
              <ion-card-content>
                <div class="cliente-detail">

                  <!-- Header con badge y bot贸n cerrar -->
                  <div class="detail-header">
                    <div class="header-left">
                      <div class="orden-badge-large">
                        {{ clienteSeleccionado.ordenVisita }}
                      </div>
                      <div class="detail-info">
                        <div class="cliente-nombre">
                          {{ clienteSeleccionado.nombreNegocio || clienteSeleccionado.representante }}
                        </div>
                        <div class="cliente-direccion">
                          <ion-icon name="location"></ion-icon>
                          {{ clienteSeleccionado.direccion }}
                        </div>
                        <div class="cliente-colonia">
                          {{ clienteSeleccionado.colonia }}
                        </div>
                      </div>
                    </div>
                    <ion-button fill="clear" size="small" class="close-button" (click)="cerrarSeleccion()">
                      <ion-icon name="close" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>

                  <!-- Informaci贸n adicional -->
                  <div class="detail-body">
                    @if (clienteSeleccionado.nombreNegocio) {
                    <div class="info-row">
                      <ion-icon name="person-outline"></ion-icon>
                      <span>{{ clienteSeleccionado.representante }}</span>
                    </div>
                    }
                    <div class="info-tags">
                      <div class="tag tag-precio">
                        <ion-icon name="cash-outline"></ion-icon>
                        <span>${{ clienteSeleccionado.precioGarrafon }}</span>
                      </div>

                      @if (clienteSeleccionado.esCredito) {
                      <ion-badge color="warning">
                        Cr茅dito
                      </ion-badge>
                      }

                      @if (clienteSeleccionado.requiereFactura) {
                      <ion-badge color="tertiary">
                        Factura
                      </ion-badge>
                      }
                    </div>

                    <ion-button expand="block" class="edit-button"
                      (click)="editarDireccion(clienteSeleccionado, $event)">
                      <ion-icon name="create-outline" slot="start"></ion-icon>
                      Editar ubicaci贸n
                    </ion-button>
                  </div>
                </div>
              </ion-card-content>
            </ion-card>
          </div>
          }
          <!-- Lista de domicilios (3 o todas) -->
          <div class="domicilios-list">
            <div class="list-header">
              <div class="list-title">
                <ion-icon name="list-outline"></ion-icon>
                <span>Lista de domicilios</span>
              </div>
              <ion-button size="small" fill="clear" class="toggle-button" (click)="toggleVerTodasCards()">
                {{ mostrarTodasCards ? 'Ver menos' : 'Ver todas (' + mapaRuta.clientes.length + ')' }}
                <ion-icon [name]="mostrarTodasCards ? 'chevron-up' : 'chevron-down'" slot="end"></ion-icon>
              </ion-button>
            </div>

            <div class="cards-container">
              @for (cliente of getClientesAMostrar(); let i = $index; track i) {
              <ion-card [class.selected]="clienteSeleccionado?.numeroCliente === cliente.numeroCliente"
                (click)="seleccionarClienteDesdeCard(cliente, i)" class="domicilio-card" button>
                <ion-card-content>
                  <div class="domicilio-content">

                    <!-- Badge de orden -->
                    <div class="orden-badge">
                      {{ cliente.ordenVisita }}
                    </div>

                    <!-- Informaci贸n -->
                    <div class="domicilio-info">
                      <div class="domicilio-nombre">
                        {{ cliente.nombreNegocio || cliente.representante }}
                      </div>
                      <div class="domicilio-direccion">
                        <ion-icon name="location-outline"></ion-icon>
                        {{ cliente.direccion }}
                      </div>
                      <div class="domicilio-tags">
                        <span class="tag-small">${{ cliente.precioGarrafon }}</span>
                        @if (cliente.esCredito) {
                        <span class="tag-small">Cr茅dito</span>
                        }
                        @if (cliente.requiereFactura) {
                        <span class="tag-small">Factura</span>
                        }
                      </div>
                    </div>

                    <!-- Bot贸n editar -->
                    <ion-button fill="clear" size="small" class="edit-icon-button"
                      (click)="editarDireccion(cliente, $event)">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </ion-card-content>
              </ion-card>
              }
            </div>
          </div>

        </div>
        }
      </div>
      }
    </div>
    }
    <!-- MODAL PARA EDITAR DIRECCIN -->
    <ion-modal #editModal [isOpen]="mostrarModalEdicion" (didDismiss)="cerrarModalEdicion()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="primary">
            <ion-title>Editar Direcci贸n</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cerrarModalEdicion()">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        @if (clienteEnEdicion) {
        <ion-content>
          <div class="edit-content">

            <!-- Vista previa del mapa con nueva ubicaci贸n -->
            <ion-card>
              <ion-card-header>
                <ion-card-subtitle>Ubicaci贸n Actual</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <div id="edit-map" class="edit-map"></div>
              </ion-card-content>
            </ion-card>

            <!-- Formulario de edici贸n -->
            <ion-card>
              <ion-card-content>
                <ion-list>

                  <ion-item>
                    <ion-label position="stacked">
                      <strong>Direcci贸n</strong>
                    </ion-label>
                    <ion-input [(ngModel)]="clienteEnEdicion.direccion" placeholder="Ingrese la direcci贸n">
                    </ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="stacked">
                      <strong>Colonia</strong>
                    </ion-label>
                    <ion-input [(ngModel)]="clienteEnEdicion.colonia" placeholder="Ingrese la colonia">
                    </ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="stacked">
                      <strong>Latitud</strong>
                    </ion-label>
                    <ion-input type="number" [(ngModel)]="clienteEnEdicion.latitud"
                      (ionChange)="actualizarMapaEdicion()" placeholder="Ej: 17.0732">
                    </ion-input>
                  </ion-item>

                  <ion-item>
                    <ion-label position="stacked">
                      <strong>Longitud</strong>
                    </ion-label>
                    <ion-input type="number" [(ngModel)]="clienteEnEdicion.longitud"
                      (ionChange)="actualizarMapaEdicion()" placeholder="Ej: -96.7266">
                    </ion-input>
                  </ion-item>

                </ion-list>

                <div class="edit-actions">
                  <ion-button expand="block" color="medium" fill="outline" (click)="cerrarModalEdicion()">
                    Cancelar
                  </ion-button>

                  <ion-button expand="block" color="primary" (click)="guardarEdicion()">
                    <ion-icon name="save" slot="start"></ion-icon>
                    Guardar Cambios
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>

          </div>
        </ion-content>
        }
      </ng-template>
    </ion-modal>

  </div>
</ion-content>

<!-- FOOTER -->
@if (mostrarVistaPrevia && datosExcel.length > 0) {
<ion-footer>
  <ion-toolbar>
    <div class="footer-buttons">
      <ion-button expand="block" color="danger" fill="outline" (click)="limpiarArchivo()" [disabled]="loading">
        <ion-icon name="close-circle" slot="start"></ion-icon>
        Cancelar
      </ion-button>

      <ion-button expand="block" color="success" (click)="confirmarImportacion()" [disabled]="loading">
        @if (loading) {
        <ion-spinner name="crescent"></ion-spinner>
        }
        @if (!loading) {
        <ion-icon name="cloud-upload" slot="start"></ion-icon>
        }
        {{ loading ? 'Importando...' : `Importar ${datosExcel.length}` }}
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>
}