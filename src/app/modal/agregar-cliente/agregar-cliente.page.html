<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-title>Nuevo Cliente</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cerrarModal()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <div class="form-container">
    <p class="intro-text">Ingresa los datos y ubica el domicilio en el mapa.</p>

    <form [formGroup]="formCliente">
      
      <h3 class="section-title">Datos Personales</h3>

      <!-- NOMBRE (campo requerido en DTO) -->
      <ion-item lines="none">
        <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Nombre" 
          labelPlacement="floating" 
          formControlName="nombre"
          placeholder="Nombre del representante">
        </ion-input>
      </ion-item>
      @if (formCliente.get('nombre')?.invalid && formCliente.get('nombre')?.touched) {
        <div class="error-msg">Nombre requerido (mínimo 3 caracteres)</div>
      }

      <!-- NEGOCIO (opcional) -->
      <ion-item lines="none">
        <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Negocio" 
          labelPlacement="floating" 
          formControlName="negocio"
          placeholder="Nombre del negocio (opcional)">
        </ion-input>
      </ion-item>

      <!-- NÚMERO DE CLIENTE (opcional) -->
      <ion-item lines="none">
        <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Número de Cliente" 
          labelPlacement="floating" 
          formControlName="cte"
          type="number"
          placeholder="CTE (opcional)">
        </ion-input>
      </ion-item>
      
      <!-- TELÉFONO (requerido) -->
      <ion-item lines="none">
        <ion-icon name="call-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Teléfono" 
          labelPlacement="floating" 
          formControlName="telefono"
          type="tel"
          maxlength="15"
          placeholder="10 dígitos">
        </ion-input>
      </ion-item>
      @if (formCliente.get('telefono')?.invalid && formCliente.get('telefono')?.touched) {
        <div class="error-msg">Teléfono requerido (máximo 15 caracteres)</div>
      }
      
      <!-- CORREO (opcional) -->
      <ion-item lines="none">
        <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Correo" 
          labelPlacement="floating" 
          formControlName="correo"
          type="email"
          placeholder="correo@ejemplo.com (opcional)">
        </ion-input>
      </ion-item>
      @if (formCliente.get('correo')?.invalid && formCliente.get('correo')?.touched) {
        <div class="error-msg">Correo inválido</div>
      }

      <!-- TIPO DE PRECIO (requerido) -->
      <ion-item lines="none">
        <ion-icon name="pricetag-outline" slot="start" color="primary"></ion-icon>
        <ion-select 
          label="Tipo de Precio" 
          labelPlacement="floating" 
          formControlName="tipoPrecioId"
          interface="popover" 
          placeholder="Seleccionar tarifa"> 
          
          @for (precio of listaPrecios; track precio.id) {
            <ion-select-option [value]="precio.id">
              {{ precio.tipoCompra }} - ${{ precio.precioPorGarrafon }}
            </ion-select-option>
          }
        </ion-select>
      </ion-item>
      @if (formCliente.get('tipoPrecioId')?.invalid && formCliente.get('tipoPrecioId')?.touched) {
        <div class="error-msg">Selecciona un tipo de precio</div>
      }

      <h3 class="section-title ion-margin-top">Ubicación</h3>

      <!-- CALLE (requerido) -->
      <ion-item lines="none">
        <ion-icon name="map-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Calle y Número" 
          labelPlacement="floating" 
          formControlName="calle"
          placeholder="Calle Principal #123">
        </ion-input>
      </ion-item>
      @if (formCliente.get('calle')?.invalid && formCliente.get('calle')?.touched) {
        <div class="error-msg">Calle requerida</div>
      }
      
      <!-- COLONIA (requerido) -->
      <ion-item lines="none">
        <ion-icon name="home-outline" slot="start" color="primary"></ion-icon>
        <ion-input 
          label="Colonia" 
          labelPlacement="floating" 
          formControlName="colonia"
          placeholder="Nombre de la colonia">
        </ion-input>
      </ion-item>
      @if (formCliente.get('colonia')?.invalid && formCliente.get('colonia')?.touched) {
        <div class="error-msg">Colonia requerida</div>
      }

      <!-- REFERENCIA (opcional) -->
    <ion-item lines="none" class="input-rounded">
  <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
  <ion-input 
    label="Referencia" 
    labelPlacement="floating" 
    formControlName="referencia" 
    type="text"
    placeholder="Cerca de... (opcional)">
  </ion-input>
</ion-item>

      <!-- ASIGNACIÓN A RUTA (opcional) -->
      <h3 class="section-title ion-margin-top">Asignación a Ruta (Opcional)</h3>
      
      <ion-item lines="none">
        <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
        <ion-select 
          label="Ruta y Día" 
          labelPlacement="floating" 
          formControlName="diaRutaId"
          interface="action-sheet"
          placeholder="Sin asignar">
          
          @for (rutaDia of rutasDisponibles; track rutaDia.diaRutaId) {
            <ion-select-option [value]="rutaDia.diaRutaId">
              {{ rutaDia.label }}
            </ion-select-option>
          }
        </ion-select>
      </ion-item>

      <!-- MAPA -->
      <h3 class="section-title ion-margin-top">Ubicación en el Mapa</h3>
      
      <div class="map-section">
        <p class="map-instruction">
          <ion-icon name="location"></ion-icon>
          Toca en el mapa para marcar la ubicación exacta
        </p>

        <div class="map-wrapper">
          <google-map
            [center]="center"
            [zoom]="zoom"
            [options]="mapOptions"
            height="300px"
            width="100%"
            (mapClick)="agregarMarcador($event)">
            
            @if (markerPosition) {
              <map-marker 
                [position]="markerPosition"
                [options]="pinOptions">
              </map-marker>
            }
          </google-map>
        </div>

        @if (formCliente.value.latitud && formCliente.value.longitud) {
          <div class="coords-badge">
            <ion-icon name="checkmark-circle"></ion-icon>
            Lat: {{ formCliente.value.latitud.toFixed(6) }}, 
            Lng: {{ formCliente.value.longitud.toFixed(6) }}
          </div>
        }
      </div>

    </form>

    <!-- BOTONES -->
    <ion-button 
      expand="block" 
      color="primary" 
      size="large" 
      (click)="guardarCliente()"
      [disabled]="cargando">
      <ion-icon name="save-outline" slot="start"></ion-icon>
      @if (cargando) {
        Guardando...
      } @else {
        Guardar Cliente
      }
    </ion-button>

    <ion-button 
      expand="block" 
      fill="outline" 
      color="medium" 
      (click)="cerrarModal()">
      Cancelar
    </ion-button>

  </div>

</ion-content>