<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="cerrar()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ ruta.nombre }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- HEADER INFO RUTA -->
  <div class="ruta-header">
    <div class="ruta-meta">
      <span>Ruta {{ ruta.id }}</span>
    </div>

    <div class="personal-grid">
      <div class="personal-item">
        <ion-icon name="person-outline"></ion-icon>
        <div>
          <span class="label">Supervisor</span>
          <span class="value">{{ ruta.supervisor?.name || 'SIN ASIGNAR' }}</span>
        </div>
      </div>

      <div class="personal-item">
        <ion-icon name="car-outline"></ion-icon>
        <div>
          <span class="label">Repartidor</span>
          <span class="value">{{ ruta.repartidor?.name || 'SIN ASIGNAR' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SELECTOR DE DÍA -->
  <div class="selector-section">
    <ion-label>Día de visita</ion-label>
    <ion-select [(ngModel)]="diaSeleccionado" (ionChange)="cambiarDia()" interface="action-sheet"
      placeholder="Selecciona un día">
      <ion-select-option *ngFor="let dia of diasDisponibles" [value]="dia.diaSemana">
        {{ dia.diaSemana }}
      </ion-select-option>
    </ion-select>
  </div>

  <!-- ESTADÍSTICAS -->

  @if (diaSeleccionado) {
  <div class="stats-section">
    <!-- ... contenido ... -->
    <div class="stats-header">
      <span class="fecha-label">{{ getDiaActual() }}</span>
      <ion-button size="small" fill="outline" color="warning" (click)="dividirRuta()">
        <ion-icon name="cut-outline" slot="start"></ion-icon>
        Dividir
      </ion-button>
    </div>

    <div class="stats-cards">
      <div class="stat-card visitados">
        <div class="stat-numero">{{ visitados }}</div>
        <div class="stat-label">Visitados</div>
      </div>
      <div class="stat-card pendientes">
        <div class="stat-numero">{{ pendientes }}</div>
        <div class="stat-label">Pendientes</div>
      </div>
      <div class="stat-card total">
        <div class="stat-numero">{{ totalClientes }}</div>
        <div class="stat-label">Total</div>
      </div>
    </div>

    <!-- BARRA DE PROGRESO -->
    <div class="progreso-bar">
      <div class="progreso-texto">
        <span>{{ visitados }} / {{ totalClientes }} domicilios visitados</span>
      </div>
      <ion-progress-bar [value]="totalClientes > 0 ? visitados / totalClientes : 0" color="success">
      </ion-progress-bar>
    </div>
  </div>
  }


  <!-- MAPA COMPACTO -->
  <div class="mapa-section" [class.expanded]="mapaExpandido">
    <div class="mapa-header" (click)="toggleMapa()">
      <div class="mapa-titulo">
        <ion-icon name="map-outline"></ion-icon>
        <span>Mapa de Ruta</span>
        <ion-badge color="primary">{{ clientesDia.length }}</ion-badge>
      </div>
      <ion-icon [name]="mapaExpandido ? 'chevron-up' : 'chevron-down'"></ion-icon>
    </div>

    @if (mapaExpandido) {
    <div class="mapa-container">
      <!-- ... mapa ... -->
      <google-map [height]="'300px'" width="100%" [center]="center" [zoom]="zoom" [options]="mapOptions">

        <map-marker *ngFor="let marker of markers" [position]="marker.position" [label]="marker.label"
          [title]="marker.title">
        </map-marker>

      </google-map>
    </div>
    }


  </div>

  <!-- BUSCADOR -->
  <div class="search-section">
    <ion-searchbar [(ngModel)]="textoBusqueda" (ionInput)="buscarCliente($event)"
      placeholder="Buscar cliente o dirección" animated>
    </ion-searchbar>
  </div>

  <!-- LISTA DE CLIENTES -->
  <div class="clientes-section">
    <div class="clientes-header">
      <h3>{{ clientesFiltrados.length }} clientes</h3>
    </div>

    <div class="clientes-lista">
      <ion-card *ngFor="let clienteRuta of clientesFiltrados; let i = index" class="cliente-card"
        [class.visitado]="clienteRuta.visitado" [class.sin-ubicacion]="!clienteRuta.cliente.direcciones?.[0]?.latitud">

        <ion-card-content>
          <div class="card-body">

            <!-- ORDEN -->
            <div class="orden-badge">
              {{ clienteRuta.ordenVisita || i + 1 }}
            </div>

            <!-- INFO -->
            <div class="cliente-info">
              <div class="nombre">
                {{ clienteRuta.cliente.representante }}
              </div>

              <div class="direccion">
                <ion-icon name="location-outline"></ion-icon>
                {{ clienteRuta.cliente.direcciones?.[0]?.direccion || 'Sin dirección' }}
              </div>

              @if (clienteRuta.cliente.negocio) {
              <div class="negocio">
                <ion-icon name="business-outline"></ion-icon>
                {{ clienteRuta.cliente.negocio }}
              </div>
              }

              <!-- TAGS -->
              <div class="tags">
                <ion-badge color="primary">
                  ${{ clienteRuta.precio?.precioPorGarrafon || 0 }}
                </ion-badge>
                @if (clienteRuta.es_credito) {
                <ion-badge color="warning">
                  CRÉDITO
                </ion-badge>
                }

                @if (clienteRuta.requiere_factura) {
                <ion-badge color="tertiary">
                  FACTURA
                </ion-badge>
                }

                @if (!clienteRuta.cliente.direcciones?.[0]?.latitud) {
                <ion-badge color="danger">
                  <ion-icon name="warning-outline"></ion-icon>
                  SIN UBICACIÓN
                </ion-badge>
                }
              </div>
            </div>

            <!-- ACCIONES -->
            <div class="acciones">
              <ion-button fill="clear" color="warning" size="small" (click)="editarCliente(clienteRuta)">
                <ion-icon name="create-outline" slot="icon-only"></ion-icon>
              </ion-button>

              <ion-button fill="clear" color="danger" size="small" (click)="eliminarCliente(clienteRuta)">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>

          </div>
        </ion-card-content>
      </ion-card>

      <!-- VACÍO -->
      @if (clientesFiltrados.length === 0) {
      <div class="empty-state">
        <ion-icon name="search-outline"></ion-icon>
        <p>No se encontraron clientes</p>
      </div>
      }
    </div>
  </div>

</ion-content>