<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Navegaci√≥n en Ruta</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cerrarModal()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-no-padding">
  
  <ion-grid class="full-height-grid ion-no-padding">
    <ion-row class="full-height-row">
      
      <ion-col size-xs="12" size-md="4" class="panel-column ion-no-padding">
        @if (resumenRuta) {
          <div class="panel-header">
            
            <div class="kpi-container">
              <div class="kpi-box">
                <span class="label">Tiempo</span>
                <span class="value">{{ resumenRuta.tiempo }}</span>
              </div>
              <div class="kpi-box">
                <span class="label">Distancia</span>
                <span class="value">{{ resumenRuta.distancia }}</span>
              </div>
              <div class="kpi-box">
                <span class="label">Paradas</span>
                <span class="value">{{ resumenRuta.paradas }}</span>
              </div>
            </div>
            <ion-button 
              expand="block" 
              [color]="navegando && !demoActiva ? 'danger' : 'success'" 
              class="ion-margin-top"
              (click)="toggleNavegacion()">
              <ion-icon slot="start" [name]="navegando && !demoActiva ? 'stop-circle-outline' : 'navigate-circle-outline'"></ion-icon>
              {{ navegando && !demoActiva ? 'Detener GPS' : 'Iniciar GPS Real' }}
            </ion-button>

            <ion-button 
              expand="block" 
              fill="outline"
              color="tertiary" 
              class="ion-margin-top"
              (click)="demoActiva ? detenerDemoRecorrido() : iniciarDemoRecorrido()">
              <ion-icon slot="start" name="play-circle-outline"></ion-icon>
              {{ demoActiva ? 'Pausar Demo' : 'Simular Recorrido' }}
            </ion-button>

          </div>
        } @else {
          <div class="ion-padding ion-text-center">
            <ion-spinner name="dots"></ion-spinner>
            <p><small>Calculando ruta...</small></p>
          </div>
        }

        <div #panelInstrucciones id="google-panel"></div>
      </ion-col>

      <ion-col size-xs="12" size-md="8" class="map-column ion-no-padding">
        <google-map 
          height="100%" 
          width="100%" 
          [center]="center" 
          [zoom]="zoom">
          
          @if (directionsResults$ | async; as directions) {
            <map-directions-renderer 
              [directions]="directions"
              [options]="rendererOptions">
            </map-directions-renderer>
          }

          @for (punto of puntosEntrega; track punto) {
            <map-marker 
              [position]="punto.position"
              [options]="{ icon: obtenerIcono(punto.estado) }"
              [title]="punto.titulo">
            </map-marker>
          }

          @if (posicionRepartidor) {
            <map-marker 
              [position]="posicionRepartidor"
              [options]="{ icon: icons.repartidor, zIndex: 999 }">
            </map-marker>
          }

        </google-map>
      </ion-col>

    </ion-row>
  </ion-grid>
</ion-content>
