<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="volver()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ diaRuta?.nombre || 'Ruta' }}</ion-title>
    <ion-buttons slot="end">
      <!-- Toggle Voz -->
      <ion-button (click)="toggleVoz()" [color]="vozHabilitada ? 'light' : 'medium'">
        <ion-icon [name]="vozHabilitada ? 'volume-high' : 'volume-mute'"></ion-icon>
      </ion-button>
      <ion-badge color="light">
        {{ clientesVisitadosCount }}/{{ clientesOrdenados.length }}
      </ion-badge>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- MAPA -->
  <div class="map-container">
    <div id="mapRepartidor" style="height: 300px; width: 100%;"></div>

    @if (ubicacionActual) {
    <div class="ubicacion-badge">
      <ion-icon name="navigate"></ion-icon>
      <span>GPS Activo</span>
    </div>
    }

    <!-- INFORMACIN DE NAVEGACIN -->
    @if (rutaIniciada && clienteActual && distanciaAlCliente > 0) {
    <div class="navegacion-info">
      <div class="info-item">
        <ion-icon name="navigate-circle"></ion-icon>
        <span>{{ (distanciaAlCliente * 1000).toFixed(0) }} m</span>
      </div>
      <div class="info-item">
        <ion-icon name="time"></ion-icon>
        <span>{{ tiempoEstimado.toFixed(0) }} min</span>
      </div>
      <!-- Bot贸n para abrir Google Maps -->
      <ion-button size="small" fill="clear" color="light" (click)="abrirNavegacion()">
        <ion-icon name="navigate" slot="start"></ion-icon>
        Navegar
      </ion-button>
    </div>
    }
  </div>
<ion-footer class="ion-no-border" style="background: white; box-shadow: 0 -4px 10px rgba(0,0,0,0.05);">
  <div class="ion-padding">
    
    <ion-item lines="none" class="switch-container" [color]="rutaIniciada ? 'light' : 'white'">
      
      <ion-icon 
        [name]="rutaIniciada ? 'bicycle' : 'power'" 
        [color]="rutaIniciada ? 'success' : 'medium'" 
        slot="start" 
        size="large">
      </ion-icon>

      <ion-label>
        <h2 style="font-weight: bold; font-size: 18px;">
          {{ rutaIniciada ? 'Ruta Activa' : 'Desconectado' }}
        </h2>
        
        <p style="font-size: 12px; color: #666;">
          @if (!rutaIniciada) {
            Desliza para iniciar la ruta 
          } @else if (hayClientesPendientes) {
            {{ clientesPendientesCount }} entregas pendientes 
          } @else {
            隆Todo entregado! Apaga para terminar 
          }
        </p>
      </ion-label>

      <ion-toggle 
        slot="end"
        color="success"
        [checked]="rutaIniciada"
        (ionChange)="onToggleRuta($event)"
        style="transform: scale(1.2);"> </ion-toggle>

    </ion-item>

  </div>
</ion-footer>

  <!-- CLIENTE ACTUAL -->
  @if (rutaIniciada && clienteActual) {
  <ion-card class="cliente-actual-card">
    <ion-card-header>
      <div class="cliente-header">
        <div>
          <ion-badge color="warning">Cliente Actual</ion-badge>
          <ion-card-title>{{ clienteActual.cliente.nombre }}</ion-card-title>
        </div>
        <ion-button fill="clear" (click)="editarCliente()">
          <ion-icon name="create-outline" color="primary"></ion-icon>
        </ion-button>
      </div>
    </ion-card-header>

    <ion-card-content>
      <div class="cliente-info">
        <div class="info-item">
          <ion-icon name="storefront-outline"></ion-icon>
          <span>{{ clienteActual.cliente.negocio || 'Sin negocio' }}</span>
        </div>
        <div class="info-item">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ clienteActual.cliente.calle }}, {{ clienteActual.cliente.colonia }}</span>
        </div>
        <div class="info-item">
          <ion-icon name="call-outline"></ion-icon>
          <span>{{ clienteActual.cliente.telefono || 'Sin tel茅fono' }}</span>
        </div>
        <div class="info-item">
          <ion-icon name="cash-outline"></ion-icon>
          <span>${{ clienteActual.precio?.precioPorGarrafon || 'N/A' }} / garraf贸n</span>
        </div>
      </div>

      <!-- Bot贸n de navegaci贸n destacado -->
      <ion-button expand="block" fill="outline" color="primary" (click)="abrirNavegacion()" class="boton-navegar">
        <ion-icon name="navigate" slot="start"></ion-icon>
        Abrir en Google Maps
      </ion-button>

      <div class="acciones">
        <ion-button expand="block" color="success" (click)="agregarVenta()">
          <ion-icon name="checkmark-circle" slot="start"></ion-icon>
          Registrar Venta
        </ion-button>

        <ion-button expand="block" fill="outline" color="danger" (click)="saltarCliente()">
          <ion-icon name="play-skip-forward" slot="start"></ion-icon>
          Saltar Cliente
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
  }

  <!-- PRXIMOS CLIENTES -->
  @if (rutaIniciada && proximosClientes.length > 0) {
  <div class="proximos-section">
    <div class="section-header">
      <h3>Pr贸ximos Clientes</h3>
      <ion-button fill="clear" size="small" (click)="verTodosClientes()">
        Ver todos ({{ clientesOrdenados.length }})
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-button>
    </div>

    <ion-list>
      @for (cliente of proximosClientes; track cliente.id) {
      <ion-item>
        <ion-badge slot="start" color="medium">
          {{ getOrdenCliente(cliente) }}
        </ion-badge>
        <ion-label>
          <h3>{{ cliente.cliente.nombre }}</h3>
          <p>{{ cliente.cliente.colonia }}</p>
        </ion-label>
      </ion-item>
      }
    </ion-list>
  </div>
  }


</ion-content>